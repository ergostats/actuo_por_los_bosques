---
title: "Descripcion de las matrices"
format: 
  html: 
    code-fold: true
    code-summary: "Mostrar el código"
editor: visual
params: 
  especie: "TODOS"
---

# Software y librerias

```{r, message=FALSE,warning=FALSE}

# Lectura de excel:
library(readxl)

# Manejo de las bases:
library(tidyverse)

# Mapas:
library(sf)

# Limpiar bases de datos:
library(janitor)

# Match por similaridad:
library(stringdist)

# Unión por similaridad:
library(fuzzyjoin)

# Adicionales para mapas:
library(ggsn)

# Adornos de graficos:
library(scales)

# Arreglar labels en mapa:
library(ggrepel)

# Tablas
library(gt)

```

El reto se realizo con R:

```{r}

R.version

```

# Lectura de las bases

#### Catalogo variables:

```{r}
diccionario <- read_excel("data/INSUMOS ESTADISTICOS/CATALOGO_CONTROL_FORESTAL.xlsx",
                          sheet = "PFCFVS")

diccionario <- diccionario %>% 
  clean_names()
```

#### Lectura de los shapefile:

##### Cantones

```{r}
shape_can <- read_sf("data/ORGANIZACIÓN TERRITORIAL CANTONAL/ORGANIZACIaN TERRITORIAL CANTONAL.shp")

```

##### Bosques protectores y areas conservadas

```{r}
bosques_protectores <- read_sf("data/hc000_bosque_vegetacion_protectora/hc000_bosque_vegetacion_protectora.shp")

areas_conservacion <- read_sf("data/v_hc005_area_bajo_conservacion_aPolygon/",
                              stringsAsFactors = FALSE)
```

#### Lectura de los archivos:

##### Aprovechamiento forestal

```{r}
tabla_aprovechamiento <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_aprovechamiento_forestal_2022.xlsx')
```

##### Denuncias:

```{r}
tabla_denuncias<-read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_atencion_denuncias_talas_2022.xlsx')
```

##### Puestos fijos:

```{r}
tabla_puestos <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_puestos_fijos_2022.xlsx')

```

# Limpieza de los archivos:

Remover Galápagos de los shapefiles:

```{r}
shape_can <- shape_can %>% 
  filter(DPA_DESPRO != "GALÁPAGOS")
```

Proyectar las areas de conversación al plano XY:

```{r}

areas_conservacion <- st_zm(areas_conservacion, drop = TRUE)

```

Creamos diccionarios de parroquias y cantones, para poder realizar la unión de las tablas temáticas y la información de las capas geográficas.

```{r}

# Diccionario cantones:

dpa_can <- shape_can %>%
  as_tibble() %>% 
  select(matches("DPA"))

dpa_can <- dpa_can %>%
  clean_names() %>%
  mutate(join_var_can = str_c(dpa_despro, dpa_descan, sep = "-"))

```

En los casos en que la des agregación sea a nivel de cantón empleamos `join_var_can` para unir la información de cada cantón. En el caso de parroquias empleamos `join_var_par`.

Base de datos del aprovechamiento forestal del 2022:

```{r}

# Limpieza de nombres:
tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  clean_names()

# Agrupación y cálulo:
tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  group_by(provincia, canton) %>% 
  summarise(volumen_aprobado = sum(area_del_predio_has, na.rm = T),
            volumen_aprovechado = sum(area_del_programa_has, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(exceso = volumen_aprovechado - volumen_aprobado)

# Creación variable de unión:
tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  mutate(join_var_can = str_c(provincia, canton, sep = "-"))
 
# Unión con el diccionario:
tabla_aprovechamiento <- stringdist_left_join(x = dpa_can,
                                              y = tabla_aprovechamiento)
```

Base de datos de la atencion a denuncia de talas del 2022:

```{r}

# Limpieza de nombres:
tabla_denuncias<-tabla_denuncias %>%
  clean_names()

# Agrupación y cálulo:
tabla_denuncias %>% 
  group_by(canton) %>%
  summarise(denuncias=n(),
            suma_vol_retenido = sum(volumen_retenido,na.rm = T))

# Creación variable de unión:
tabla_denuncias <-tabla_denuncias %>%
  mutate(join_var_can = str_c(provincia,canton,sep = "-"))

# Unión con el diccionario: 
tabla_denuncias <-  stringdist_left_join(x=dpa_can,
                                         y=tabla_denuncias)

```

Base de datos de los puestos fijos de control para el 2022:

```{r}

# Limpieza de nombres:
tabla_puestos <- tabla_puestos %>% 
  clean_names() 

# Agrupación y cálulo:
verificaciones <- tabla_puestos %>% 
  group_by(pfcfvs) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

# Unión con el diccionario de puestos fijos de control: 
verificaciones <- verificaciones %>% 
  left_join(diccionario, by = c("pfcfvs" = "codigo"))

# Agrupación y cálulo:
origen <- tabla_puestos %>% 
  group_by(origen, origen_provincia) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

# Creación variable de unión:
origen <- origen %>% 
  mutate(join_var_can = str_c( origen_provincia,origen, sep = "-"))

# Unión con el diccionario: 
origen <- stringdist_left_join(x = dpa_can,y = origen)

```

### ¿Que tan efectivo es el control forestal en el Ecuador? Vamos a averiguarlo con las librerías `ggplot2` y `sf` de R

En Ecuador hay un total de `r nrow(diccionario)` puestos de control fijo para revisión del recurso forestal. De acuerdo a los polígonos provistos, hay un total de `r nrow(areas_conservacion)` áreas bajo conservación [(Acuerdo-Ministerial-Nro.-MAATE-2022-066)](áreas bajo conservación) y `r nrow(bosques_protectores)` áreas consideradas como bosques protectores ([Definición](http://areasprotegidas.ambiente.gob.ec/es/content/bosques-protectores#:~:text=Son%20bosques%20y%20vegetaci%C3%B3n%20protectores,condiciones%20clim%C3%A1ticas%2C%20ed%C3%A1ficas%20e%20h%C3%ADdricas%2C)).

Vamos a visualizar los puestos de control y estas áreas empleando la librería `sf` de R. En este caso estamos vamos a agregar tres capas geográficas. Utilizaremos el shapefile de cantones en nuestros gráficos.

> Da click en `Code` para seguir el paso a paso.

```{r}
# Empezamos con un ggplot() que va a tener datos independientes en cada capa:

plot_nacional <- ggplot() +
  
  # Cantones:
  geom_sf(data = shape_can,
          size = 0.1,
          fill = "#E4E3E5",
          color = "#979599") +
  # Bosques protectores:
  geom_sf(data = bosques_protectores,
          aes(fill = "Bosque protector"),
          alpha = 0.7)   +
  
  # Areas de conservación:
  geom_sf(data = areas_conservacion,
          aes(fill = "Área bajo conservación"),
          alpha = 0.7)  +
  
  # puestos de control registrados en la base de datos de revisiones en puestos fijos
  geom_point(data = verificaciones, 
             aes(x = x,
                 y = y),
             alpha = 0.6,
             size = 2.5) +
  # Etiquetas con los nombres de los puestos de control
  geom_label_repel(data = verificaciones, 
             aes(x = x,
                 y = y,
                 label = pfc),
             size = 2,
             alpha = 0.8) +
  # Colores para nuestros poligonos:
  scale_fill_manual(values  = c("Bosque protector" = "#872ADF",
                                "Área bajo conservación" = "#E8E215"))  +
  
  # Adornos para el ggplot:
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank()) +
  
  # Títulos:
  labs(title = "Puestos de control y aréas del Ecuador que requieren atención",
       subtitle = "Mapa cantonal",
       caption = "Fuente: MAATE\nElaboración: Equipo foRestEC",
       fill = "Tipo de área") +
  theme(plot.caption = element_text(hjust = 0))
```

Vemos que los puestos de control se concentra en el norte y oriente del Ecuador, donde hay una especial concentración de áreas bajo conservación. Añadamos a nuestro mapa el aprovechamiento de producto forestal. Para ello vamos a traficar el volumen aprobado para aprovechamiento total por parroquia. 

```{r}

# Unión de la tabla de resumen con el shapefile:
tabla_plot_aprovechamiento <- shape_can %>% 
  left_join(tabla_aprovechamiento, by = c("DPA_CANTON" = "dpa_canton"))

mediana_aprovechamiento <- tabla_aprovechamiento %>% 
  pull(volumen_aprobado) %>% 
  log(.) %>% 
  median(.,na.rm = T)

ggplot() +
  # Capa de aprovecgamiento:
  geom_sf(data = tabla_plot_aprovechamiento,
          aes(fill = log(volumen_aprobado)),
          size = 0.1,
          color = "#979599") +
  # Bosques protectores:
  geom_sf(data = bosques_protectores,
          aes(color = "Bosque protector"),
          fill = "transparent")   +
  # Areas de conservación:
  geom_sf(data = areas_conservacion,
          aes(color = "Área bajo conservación"),
          fill = "transparent")  +
  
  # puestos de control registrados en la base de datos de revisiones en puestos fijos
  geom_point(data = verificaciones,
             aes(x = x,
                 y = y),
             alpha = 0.6,
             size = 2.5) +
  # Etiquetas con los nombres de los puestos de control
  geom_label_repel(data = verificaciones,
                   aes(x = x,
                       y = y,
                       label = pfc),
                   size = 2,
                   alpha = 0.8) +
  # Colores para nuestros poligonos:
  scale_color_manual(values  = c("Bosque protector" = "#872ADF",
                                 "Área bajo conservación" = "#1EAAE2"))  +
  scale_fill_gradient2(low = "#3c7fb1",
                       mid = "#F9E256",
                       high = "#FF6565",
                       midpoint = mediana_aprovechamiento,
                       na.value = "#E4E3E5",
                       labels = ~scales::number(exp(.),
                                                accuracy = 1)) +
  
  # Adornos para el ggplot:
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        plot.caption = element_text(hjust = 0)) +
  
  # Títulos:
  labs(title = "Aprovechamiento forestal aprobado por cantón",
       subtitle = "Se consideran los puestos de control fijo registrados en la base de datos",
       caption = "Fuente: MAATE\nElaboración: Equipo foRestEC",
       fill = "Volumen métrico (m3)",
       colour = "Tipo de área")

```
Las áreas de mayor aprovechamiento del recurso forestal están presente se concentran en la costa centro y norte, y a lo largo de la región amazónica muy cerca de áreas bajo conservación y bosques protectores, es por ello que ¡el control forestal es tán importante!. Para mejorar la representación en los colores hemos aplicado logaritmos a los valores presentados en el mapa. Ahora veamos que pasa con el volumen aprovechado. 

```{r}
mediana_aprovechamiento <- tabla_aprovechamiento %>% 
  pull(volumen_aprovechado) %>% 
  log(.) %>% 
  median(.,na.rm = T)

ggplot() +
  # Capa de aprovecgamiento:
  geom_sf(data = tabla_plot_aprovechamiento,
          aes(fill = log(volumen_aprovechado)),
          size = 0.1,
          color = "#979599") +
  # Bosques protectores:
  geom_sf(data = bosques_protectores,
          aes(color = "Bosque protector"),
          fill = "transparent")   +
  # Areas de conservación:
  geom_sf(data = areas_conservacion,
          aes(color = "Área bajo conservación"),
          fill = "transparent")  +
  
  # puestos de control registrados en la base de datos de revisiones en puestos fijos
  geom_point(data = verificaciones,
             aes(x = x,
                 y = y),
             alpha = 0.6,
             size = 2.5) +
  # Etiquetas con los nombres de los puestos de control
  geom_label_repel(data = verificaciones,
                   aes(x = x,
                       y = y,
                       label = pfc),
                   size = 2,
                   alpha = 0.8) +
  # Colores para nuestros poligonos:
  scale_color_manual(values  = c("Bosque protector" = "#872ADF",
                                 "Área bajo conservación" = "#1EAAE2"))  +
  scale_fill_gradient2(low = "#3c7fb1",
                       mid = "#F9E256",
                       high = "#FF6565",
                       midpoint = mediana_aprovechamiento,
                       na.value = "#E4E3E5",
                       labels = ~scales::number(exp(.),
                                                accuracy = 1)) +
  
  # Adornos para el ggplot:
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        plot.caption = element_text(hjust = 0)) +
  
  # Títulos:
  labs(title = "Aprovechamiento forestal aprovechado por cantón",
       subtitle = "Se consideran los puestos de control fijo registrados en la base de datos",
       caption = "Fuente: MAATE\nElaboración: Equipo foRestEC",
       fill = "Volumen métrico (m3)",
       colour = "Tipo de área")

```


Es chevere ver que la sintaxis que hemos empleado tiene la misma estructura, lo que permite reproducir el código con facilidad. Con está distribución del aprovechamiento del recurso forestal la pregunta que nos nace es: En que lugares existe una diferencia considerable entre el volumen aprobado para  ser aprovechado y el volumen efectivamente aprovechado. Aquí vamos a hacer un cambio sutil en la presentación del gráfico.

```{r}
mediana_aprovechamiento <- tabla_aprovechamiento %>% 
  pull(exceso) %>% 
  median(.,na.rm = T)

ggplot() +
  # Capa de aprovecgamiento:
  geom_sf(data = tabla_plot_aprovechamiento,
          aes(fill = exceso),
          size = 0.1,
          color = "#979599") +
  # Bosques protectores:
  geom_sf(data = bosques_protectores,
          aes(color = "Bosque protector"),
          fill = "transparent")   +
  # Areas de conservación:
  geom_sf(data = areas_conservacion,
          aes(color = "Área bajo conservación"),
          fill = "transparent")  +
  
  # puestos de control registrados en la base de datos de revisiones en puestos fijos
  geom_point(data = verificaciones,
             aes(x = x,
                 y = y),
             alpha = 0.6,
             size = 2.5) +
  # Etiquetas con los nombres de los puestos de control
  geom_label_repel(data = verificaciones,
                   aes(x = x,
                       y = y,
                       label = pfc),
                   size = 2,
                   alpha = 0.8) +
  # Colores para nuestros poligonos:
  scale_color_manual(values  = c("Bosque protector" = "#872ADF",
                                 "Área bajo conservación" = "#1EAAE2"))  +
  scale_fill_gradient2(low = "#3c7fb1",
                       mid = "#F9E256",
                       high = "#FF6565",
                       midpoint = mediana_aprovechamiento,
                       na.value = "#E4E3E5",
                       labels = ~scales::number(.,accuracy = 1)) +
  
  # Adornos para el ggplot:
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        plot.caption = element_text(hjust = 0)) +
  
  # Títulos:
  labs(title = "Diferencias entre volumenes aprobado y aprovechado por cantón",
       subtitle = "Se consideran los puestos de control fijo registrados en la base de datos",
       caption = "Fuente: MAATE\nElaboración: Equipo foRestEC",
       fill = "Volumen métrico (m3)",
       colour = "Tipo de área")
```

Es bueno saber que en general en el Ecuador hay una sub-utilización del recurso forestal, lo que facilita la conservación. Sin embargo los cantones, donde la diferencia entre aprovechamiento y el volumen aprobado es cercana a cero son:

```{r}

tabla_aprovechamiento %>% 
  as_tibble() %>% 
  select(dpa_descan,dpa_despro,volumen_aprobado,volumen_aprovechado,exceso) %>% 
  slice_max(order_by = exceso,n = 5) %>% 
  gt() %>% 
  cols_label(dpa_descan = mn("**Cantón**"),
             dpa_despro = mn("**Provincia**"),
             volumen_aprobado = mn("**Volumen aprobado**"),
             volumen_aprovechado = mn("**Volumen aprovechado**"),
             exceso = mn("**Diferencia**"))
```

Tres gráficos más nos darán una idea de la pertinencia de la ubicación de los puestos de control. Sin embargo, por el momento podemos concluir que la distribución actual de estos puestos de control  que ha empleado el MAATE se corresponde con el volumen de aprovechamiento. 

En esta ocasión vamos a añadir el atributo de tamaño al punto del puesto de control, el cual tomará valores de acuerdo al número de controles realizados para verificar el volumen de producto forestal y el tráfico de fauna silvestre, revisión que se realiza a los distintos medios de transporte. Fijate como en la capa de la tabla temática agregamos el argumento `size = frecuencia`. 


```{r, eval = FALSE}


tabla_plot <- shape_can %>% 
  left_join(origen, by = c("DPA_CANTON" = "dpa_canton"))


tabla_plot %>% 
  ggplot() +
  geom_sf(data = tabla_plot,
          aes(fill = log(frecuencia)),
          size = 0.1,
          color = "#979599") +
  geom_sf(data = bosques_protectores,
          aes(color = "bosque protector"),
          fill = "transparent")   +
  geom_sf(data = areas_conservacion,
          aes(color = "area consarvada"),
          fill = "transparent")  +
  geom_point(data = verificaciones, 
             aes(x = x,
                 y = y,
                 size = frecuencia),
             alpha = 0.4) +
  scale_size_continuous(range = c(2,10)) +
  scale_fill_gradient2(low = "#3c7fb1",
                       mid = "#5bc9e5",
                       high = "#8fcf9c",
                       midpoint = 4,
                       labels = ~scales::number(exp(.),
                                                accuracy = 1)) +
  scale_color_manual(values  = c("#872ADF","#E8E215")) +
  labs(title = "Número de verificaciones por cantón",
       subtitle = "Los puntos representan los puestos de control forestal",
       caption = "Fuente: MAATE")
```

Grafico de Aprovechamiento Forestal:

```{r, eval = FALSE}
tabla_plot_aprovechamiento <- shape_can %>% 
  left_join(tabla_aprovechamiento, by = c("DPA_PARROQ" = "dpa_parroq")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS") 

tabla_plot_aprovechamiento %>% 
  ggplot() +
  geom_sf(aes(fill = suma_area_programa)) +
  geom_point(data = diccionario, 
             aes(x = x,
                 y = y)) +
    labs(title = "Areas del programa de aprovechamiento forestal por cantón",
         subtitle = "Los puntos representan las areas de aprovechamiento forestal por canton",
         caption = "Fuente: MAATE")
```

Volúmen retenido y número de denuncias por provincia:

```{r, eval = FALSE}
tabla_plot_denuncias <- shape_can %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")
tabla_plot_denuncias %>%
  ggplot()+
  geom_sf(aes(fill =suma_vol_retenido )) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Número de denuncias por cantón",
       subtitle = "Los puntos son las denuncias realizadas",
       caption = "Fuente: MAATE")

```

```{r, eval = FALSE}
tabla_plot_volumen <- shape_can %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")

tabla_plot_volumen %>%
  ggplot()+
  geom_sf(aes(fill = denuncias)) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Volúmen retenido por cantón",
       subtitle = "Los puntos son el volúmen",
       caption = "Fuente: MAATE")
```
