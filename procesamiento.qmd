---
title: "Descripcion de las matrices"
format: html
editor: visual
---

# Software y librerias

```{r, message=FALSE,warning=FALSE}

# Lectura de excel:
library(readxl)

# Manejo de las bases:
library(tidyverse)

# Mapas:
library(sf)

# Limpiar bases de datos:
library(janitor)

# Match por similaridad:
library(stringdist)

# Unión por similaridad:
library(fuzzyjoin)

# Adicionales para mapas:
library(ggsn)

```
El reto se realizo con R:

```{r}

R.version

```



# Lectura de las bases

#### Catalogo variables:

```{r}
diccionario <- read_excel("data/INSUMOS ESTADISTICOS/CATALOGO_CONTROL_FORESTAL.xlsx",
                          sheet = "PFCFVS")

diccionario <- diccionario %>% 
  clean_names()
```

#### Lectura de los shapefile:

##### Cantones

```{r}
shape_can <- read_sf("data/ORGANIZACIÓN TERRITORIAL CANTONAL/ORGANIZACIaN TERRITORIAL CANTONAL.shp")

shape_can <- shape_can %>% 
  filter(DPA_DESPRO != "GALÁPAGOS")
```

##### Parroquias

```{r}
shape_par <- read_sf("data/ORGANIZACION_TERRITORIAL_PARROQUIAL/ORGANIZACION_TERRITORIAL_PARROQUIAL.shp")

shape_par <- shape_par %>% 
  filter(DPA_DESPRO != "GALÁPAGOS")
```

##### Bosques protectores y areas conservadas

```{r}
bosques_protectores <- read_sf("data/hc000_bosque_vegetacion_protectora/hc000_bosque_vegetacion_protectora.shp")

areas_conservacion <- read_sf("data/v_hc005_area_bajo_conservacion_aPolygon/")
```

#### Lectura de los archivos:

##### Aprovechamiento forestal

```{r}
tabla_aprovechamiento <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_aprovechamiento_forestal_2022.xlsx')
```

##### Denuncias:

```{r}
tabla_denuncias<-read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_atencion_denuncias_talas_2022.xlsx')
```

##### Puestos fijos:

```{r}
tabla_puestos <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_puestos_fijos_2022.xlsx')

```

# Limpieza de los archivos:

```{r}
dpa_can <- shape_can %>%
  as_tibble() %>% 
  select(matches("DPA"))


dpa_can <- dpa_can %>%
  clean_names() %>%
  mutate(join_var_can = str_c(dpa_despro, dpa_descan, sep = "-"))

dpa_par <- shape_par %>%
  as_tibble() %>% 
  select(matches("DPA"))

dpa_par <- dpa_par %>%
  clean_names() %>%
  mutate(join_var_can = str_c(dpa_despro, dpa_descan, sep = "-"),
         join_var_par = str_c(dpa_despro, dpa_descan, dpa_despar, sep = "-"))


```

Base de datos del aprovechamiento forestal del 2022:

```{r}



tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  clean_names()

tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  group_by(provincia, canton, parroquia) %>% 
  summarise(suma_area_predio = sum(area_del_predio_has, na.rm = T),
            suma_area_programa = sum(area_del_programa_has, na.rm = T))

tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  mutate(join_var_can = str_c(provincia, canton , sep = "-"))
 
 
tabla_aprovechamiento <- stringdist_left_join(x = dpa,y = tabla_aprovechamiento)
```

Base de datos de la atencion a denuncia de talas del 2022:

```{r}

tabla_denuncias<-tabla_denuncias %>%
  clean_names()

tabla_denuncias %>% 
  group_by(canton) %>%
  summarise(denuncias=n(),
            suma_vol_retenido = sum(volumen_retenido,na.rm = T))

tabla_denuncias <-tabla_denuncias %>%
  mutate(join_var_can = str_c(provincia,canton,sep = "-"))
 
tabla_denuncias <-  stringdist_left_join(x=dpa,
                                          y=tabla_denuncias)

```

Base de datos de los puestos fijos de control para el 2022:

```{r}


tabla_puestos <- tabla_puestos %>% 
  clean_names() 
```



Origenes y destinos:

```{r}

verificaciones <- tabla_puestos %>% 
  group_by(pfcfvs) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

verificaciones <- verificaciones %>% 
  left_join(diccionario, by = c("pfcfvs" = "codigo"))

# verificaciones_sf <- verificaciones %>% 
#   st_as_sf(coords = c("x","y"))

origen <- tabla_puestos %>% 
  group_by(origen, origen_provincia) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

origen <- origen %>% 
  mutate(join_var_can = str_c( origen_provincia,origen, sep = "-"))

origen <- stringdist_left_join(x = dpa_can,y = origen)

```

### Graficos:

Número de revisiones forestales por origen del recurso:

```{r}


tabla_plot <- shape_can %>% 
  left_join(origen, by = c("DPA_CANTON" = "dpa_canton"))
# %>% 
#   filter(DPA_DESPRO != "GALAPAGOS") 

tabla_plot %>% 
  ggplot() +
  geom_sf(data = tabla_plot,
          aes(fill = frecuencia)) +
  geom_sf(data = bosques_protectores,
          fill = "green",
          alpha = 0.2)  +
  geom_sf(data = areas_conservacion,
          fill = "yellow",
          alpha = 0.2) +
  geom_point(data = diccionario, 
             aes(x = x,
                 y = y)) +
    labs(title = "Número de verificaciones por cantón",
         subtitle = "Los puntos representan los puntos de control forestal",
         caption = "Fuente: MAATE")
```

Grafico de Aprovechamiento Forestal:

```{r}
tabla_plot_aprovechamiento <- shape_can %>% 
  left_join(tabla_aprovechamiento, by = c("DPA_PARROQ" = "dpa_parroq")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS") 

tabla_plot_aprovechamiento %>% 
  ggplot() +
  geom_sf(aes(fill = suma_area_programa)) +
  geom_point(data = diccionario, 
             aes(x = x,
                 y = y)) +
    labs(title = "Areas del programa de aprovechamiento forestal por cantón",
         subtitle = "Los puntos representan las areas de aprovechamiento forestal por canton",
         caption = "Fuente: MAATE")
```

Volúmen retenido y número de denuncias por provincia:

```{r}
tabla_plot_denuncias <- shape_can %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")
tabla_plot_denuncias %>%
  ggplot()+
  geom_sf(aes(fill =suma_vol_retenido )) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Número de denuncias por cantón",
       subtitle = "Los puntos son las denuncias realizadas",
       caption = "Fuente: MAATE")

```

```{r}
tabla_plot_volumen <- shape_can %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")

tabla_plot_volumen %>%
  ggplot()+
  geom_sf(aes(fill = denuncias)) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Volúmen retenido por cantón",
       subtitle = "Los puntos son el volúmen",
       caption = "Fuente: MAATE")
```
