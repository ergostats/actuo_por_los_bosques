---
title: "Descripcion de las matrices"
format: html
editor: visual
---

## Lectura de las bases

```{r}
library(readxl)
library(tidyverse)
library(sf)
library(janitor)
library(stringdist)
library(fuzzyjoin)
```

Catalogo variables:

```{r}
diccionario <- read_excel("data/INSUMOS ESTADISTICOS/CATALOGO_CONTROL_FORESTAL.xlsx",
                          sheet = "PFCFVS")

diccionario <- diccionario %>% 
  clean_names()
```

Lectura del shapefile:

```{r}

shape <- read_sf("data/ORGANIZACION_TERRITORIAL_PARROQUIAL/ORGANIZACION_TERRITORIAL_PARROQUIAL.shp")

dpa <- shape %>%
  as_tibble() %>% 
  select(matches("DPA"))


dpa <- dpa %>% 
  clean_names() %>% 
  mutate(join_var_can = str_c(dpa_despro, dpa_descan, sep = "-"),
         join_var_par = str_c(dpa_despro, dpa_descan, dpa_despar, sep = "-"))


```

Base de datos del aprovechamiento forestal del 2022:

```{r}
tabla_aprovechamiento <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_aprovechamiento_forestal_2022.xlsx')


tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  clean_names()

tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  group_by(provincia, canton, parroquia) %>% 
  summarise(suma_area_predio = sum(area_del_predio_has, na.rm = T),
            suma_area_programa = sum(area_del_programa_has, na.rm = T))

tabla_aprovechamiento <- tabla_aprovechamiento %>% 
  mutate(join_var_can = str_c(provincia, canton , sep = "-"))
 
 
tabla_aprovechamiento <- stringdist_left_join(x = dpa,y = tabla_aprovechamiento)
```

Base de datos de la atencion a denuncia de talas del 2022:

```{r}
tabla_denuncias<-read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_atencion_denuncias_talas_2022.xlsx')


tabla_denuncias<-tabla_denuncias %>%
  clean_names()

tabla_denuncias %>% 
  group_by(canton) %>%
  summarise(denuncias=n(),
            suma_vol_retenido = sum(volumen_retenido,na.rm = T))

tabla_denuncias <-tabla_denuncias %>%
  mutate(join_var_can = str_c(provincia,canton,sep = "-"))
 
tabla_denuncias <-  stringdist_left_join(x=dpa,
                                          y=tabla_denuncias)

```

Base de datos del destino final de los recursos para el 2022:

```{r}
read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_destino_final_2022.xlsx')
```

Base de datos de los puestos fijos de control para el 2022:

```{r}
tabla_puestos <- read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_puestos_fijos_2022.xlsx')

tabla_puestos <- tabla_puestos %>% 
  clean_names() 
```

Base de datos de las unidades moviles de control para el 2022:

```{r}
read_excel('data/INSUMOS ESTADISTICOS/MAATE_BDD_unidades_moviles_2022.xlsx')
```

Limpieza shape:

```{r}

verificaciones <- tabla_puestos %>% 
  group_by(pfcfvs) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

verificaciones <- verificaciones %>% 
  left_join(diccionario, by = c("pfcfvs" = "codigo"))

# verificaciones_sf <- verificaciones %>% 
#   st_as_sf(coords = c("x","y"))

origen <- tabla_puestos %>% 
  group_by(origen, origen_provincia) %>% 
  summarise(frecuencia = n(),
            cubicado = sum(cubicado_vtotal, na.rm = T),
            retencion = sum(vol_ret,na.rm = T))

origen <- origen %>% 
  mutate(join_var_can = str_c( origen_provincia,origen, sep = "-"))

origen <- stringdist_left_join(x = dpa,y = origen)

```

### Graficos:

Número de revisiones forestales por origen del recurso:

```{r}
tabla_plot <- shape %>% 
  left_join(origen, by = c("DPA_PARROQ" = "dpa_parroq")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS") 

tabla_plot %>% 
  ggplot() +
  geom_sf(aes(fill = frecuencia)) +
  geom_point(data = diccionario, 
             aes(x = x,
                 y = y)) +
    labs(title = "Número de verificaciones por cantón",
         subtitle = "Los puntos representan los puntos de control forestal",
         caption = "Fuente: MAATE")
```

Volúmen retenido y número de denuncias por provincia:

```{r}
tabla_plot_denuncias <- shape %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")
tabla_plot_denuncias %>%
  ggplot()+
  geom_sf(aes(fill =suma_vol_retenido )) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Número de denuncias por cantón",
       subtitle = "Los puntos son las denuncias realizadas",
       caption = "Fuente: MAATE")

```

```{r}
tabla_plot_volumen <- shape %>%
  left_join(tabla_denuncias, by = c("DPA_CANTON" = "dpa_canton")) %>% 
  filter(DPA_DESPRO != "GALAPAGOS")

tabla_plot_volumen %>%
  ggplot()+
  geom_sf(aes(fill = denuncias)) + 
  geom_point(data = diccionario,
             aes(x = x,
                 y = y)) +
  labs(title = "Volúmen retenido por cantón",
       subtitle = "Los puntos son el volúmen",
       caption = "Fuente: MAATE")
```
